<!DOCTYPE html> 
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width,initial-scale=1.0">
		<meta name="description" content="">
		<meta name="author" content="">

		<title>ISCloud</title> 

				
		<style type="text/css">
			body {
				padding-top: 60px; padding-bottom: 40px;
			}
			.sidebar-nav {
				padding: 9px 0;
			} 
			@media (max-width: 980px) {
				/* Enable use of floated navbar text */
				.navbar-text.pull-right {
					float: none; padding-left: 5px; padding-right: 5px;
				}
			}
		</style>
	</head> 
	<body>
		<div class="navbar navbar-fixed-top">
			<div class="navbar-inner">
				<div class="container-fluid">
					<button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
						<span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span>
					</button> <a class="brand" href="#">ISCloud Estudiante</a>
					<div class="nav-collapse collapse">
						<p class="navbar-text pull-right">
							Autenticado en el sistema como <b> <a href="#" class="navbar-link">mb.juan10</a> </b>
						</p>
						<ul class="nav">
							<li class="active">
								<a href="#">Cursos</a>
							</li>
							<li>
								<a href="#about">Proyectos</a>
							</li>
						</ul>
					</div><!--/.nav-collapse -->
				</div>
			</div>
		</div>
		<div class="container-fluid">
			<div class="row-fluid">
				<div class="span3">
					<div class="well sidebar-nav">
						<ul class="nav nav-list">
							<li class="nav-header">
								MISIS
							</li> 
							<li class="active">
								<a href="#">ISIS 3510-2 Construcción aplicaciones móviles </a>
							</li>
							<li>
								<a href="#">ISIS 3502-1 Sistemas Manejadores de Bases de Datos</a>
							</li>
						</ul>
					</div><!--/.well -->
				</div><!--/span--> 
				<div class="span9">
					<div id="main" class="container">
						<table class="table table-striped">
							<tr>
								<th style="width: 1px;"></th> 
								<th><b>Laboratorios virtuales</b></th>
								<th><b>Operaciones</b></th>
								<th><b>Guardar estado</b></th>
								<th><b>Estados anteriores</b></th>
							</tr> 
							<!-- ko foreach: tasks -->
								<tr>
									<td>
										<span data-bind="visible: activo()" class="label label-success">Activo</span>
										<span data-bind="visible: inactivo()" class="label label-important">Inactivo</span>
										<span data-bind="visible: pausado();" class="label">Pausado</span>
										<span class="label label-warning">Plazo: <span data-bind="text: plazo">	</span> días</span>
									</td>
									<td>
										<p>
											<b data-bind="text: titulo"></b>
											<br /><b data-bind="text: descripcion"></b>
										</p>
										<b>Usuario: </b><b data-bind="text: usuario"></b>
										<br />
										<b>Password: </b><b data-bind="text: password"></b>
										<br />
										<a href=""><span data-bind="text: accesoDirecto">Descargar acceso directo</span></a>
									</td>
									<td>
										<span data-bind="visible: !activo()">
											<button data-bind="click: $parent.marcarActivo" class="btn">
												<i class="icon-play"></i> Iniciar
											</button> 
										</span>
										<span data-bind="visible: !pausado() && activo()">
											<button data-bind="click: $parent.marcarPausado" class="btn">
												<i class="icon-pause"></i> Pausar
											</button> 
										</span>
										<span data-bind="visible: !inactivo()">
											<button data-bind="click: $parent.marcarInactivo" class="btn">
												<i class="icon-stop"></i> Terminar
											</button> 
										</span>
										<br /> 
										<button data-bind="click: $parent.reportarProblema" class="btn btn-danger" style="margin-top:10px;">
											<i class="icon-envelope icon-white"></i> Reportar problema
										</button>
									</td>
									<td> <button data-bind="click: $parent.guardarEstado" class="btn">
										<i class="icon-camera"></i> Guardar estado</button>
										<br />
									</td>
									<td> 
										<select name="comboBoxRestaurarEstado" style="width: 250px;">
											<optgroup label="Viernes 15/11/2013">
												<option value="345">19:42:01 - Proyecto funcionando</option>
												<option value="456">16:00:30 - Antes de la prueba 2</option>
											</optgroup> 
											<optgroup label="Jueves 14/11/2013">
												<option value="234">11:50:10 - Antes de prueba 1</option>
												<option value="123">10:30:54 - Apenas inicié el laboratorio</option>
											</optgroup>
										</select>
										<br />
										<button data-bind="click: $parent.restaurarEstado" class="btn">
											<i class="icon-fast-backward"></i> Restaurar estado
										</button>
									</td>
								</tr> 
							<!-- /ko -->
						</table>
					</div>

					<div id="login" class="modal hide fade" tabindex="=1" role="dialog" aria-labelledby="loginLabel" aria-hidden="true">
						<div class="modal-header">
							<h3 id="loginLabel">Sign In</h3>
						</div>
						<div class="modal-body">
							<form class="form-horizontal">
								<div class="control-group">
									<label class="control-label" for="inputUsername">Username</label>
									<div class="controls">
										<input data-bind="value: username" type="text" id="inputUsername" placeholder="Username">
									</div>
								</div>
								<div class="control-group">
									<label class="control-label" for="inputPassword">Password</label>
									<div class="controls">
										<input data-bind="value: password" type="password" id="inputPassword" placeholder="Password">
									</div>
								</div>
							</form>
						</div>
						<div class="modal-footer">
							<button data-bind="click: login" class="btn btn-primary" data-dismiss="modal" aria-hidden="true">Sign In</button>
						</div>
					</div>

				</div><!--/span-->
			</div><!--/row-->
		</div>

		<div id="reportarFuncionamientoIncorrecto" class="modal hide fade" tabindex="=1" role="dialog" aria-labelledby="reportarFuncionamientoIncorrectoDialogLabel" aria-hidden="true">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
				<h3>Reportar problema</h3>
			</div>
			<div class="modal-body">
				<form class="form-horizontal">
					<div class="control-group">
						<label class="control-label" for="selectTipoDeProblema">Tipo de problema</label>
						<div class="controls">
							<select class="span3" id="selectTipoDeProblema">
								<option>Recursos computacionales asignados erróneos</option>
								<option>Programa no funcionando</option>
								<option>Máquina lenta</option>
								<option>Error de sistema operativo</option>
								<option>Error de credenciales</option>
								<option>Error de conexión</option>
							</select>
						</div>
					</div>

					<div class="control-group">
						<label class="control-label" for="textareaDescripcion">Descripcion</label>
						<div class="controls">
							<textarea rows="3" data-bind="value: descripcion" type="text" id="textareaDescripcion" placeholder="Descripcion" style="width: 250px;">
							</textarea>
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button data-bind="click: reportarFuncionamientoIncorrecto" class="btn btn-primary" type="button"><i class="icon-envelope icon-white"></i> Enviar</button>

				<button class="btn" data-dismiss="modal" aria-hidden="true">Cancelar</button>
			</div>
		</div>


		<div id="guardarEstado" class="modal hide fade" tabindex="=1" role="dialog" aria-labelledby="guardarEstadoDialogLabel" aria-hidden="true">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
				<h3>Guardar estado de ejecución</h3>
			</div>
			<div class="modal-body">
				<form class="form-horizontal">
					<div class="control-group">
						<label class="control-label" for="textareaDescripcion">Descripción</label>
						<div class="controls">
							<textarea rows="3" data-bind="value: descripcion" type="text" id="textareaDescripcion" placeholder="Descripción opcional" style="width: 250px;">
							</textarea>
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button data-bind="click: guardarEstado" class="btn btn-primary" type="button"><i class="icon-camera icon-white"></i> Guardar estado</button>

				<button class="btn" data-dismiss="modal" aria-hidden="true">Cancelar</button>
			</div>
		</div>

		<footer>
			<p>
				&copy; <a href="">Departamento de Ingeniería de Sistemas y Computación</a> - <a href="">Universidad de Los Andes</a>
			</p>
		</footer>

		<script type="text/javascript">
		
			function TasksViewModel()
			{
				var self = this; 
				self.tasks = ko.observableArray();

				self.username = "miguel";
				self.password = "python";
				
				self.tasksURI = 'http://localhost:5000/todo/api/v1.0/tasks';
	
				self.ajax = function(uri, method, data) 
				{
					var request = {
						url: uri,
						type: method,
						contentType: "application/json",
						accepts: "application/json",
						cache: false,
						dataType: 'json',
						data: JSON.stringify(data),
						beforeSend: function (xhr) {
							xhr.setRequestHeader("Authorization", "Basic " + btoa(self.username + ":" + self.password));
						},
						error: function(jqXHR) {
							console.log("ajax error " + jqXHR.status);
						}
					};
					return $.ajax(request);
				}

				self.marcarActivo = function(task)
				{
					task.activo(true);
					task.pausado(false);
					task.inactivo(false);

					self.ajax(task.uri(), 'PUT', { activo: true, pausado: false, inactivo: false }).done(function(res) {
						self.updateTask(task, res.task);
					});
				} 
				self.marcarPausado = function(task) {
					task.activo(false);
					task.pausado(true);
					task.inactivo(false);

					self.ajax(task.uri(), 'PUT', { activo: false, pausado: true, inactivo: false }).done(function(res) {
						self.updateTask(task, res.task);
					});
				} 
				self.marcarInactivo = function(task) {
					task.activo(false);
					task.pausado(false);
					task.inactivo(true);

					self.ajax(task.uri(), 'PUT', { activo: false, pausado: false, inactivo: true }).done(function(res) {
						self.updateTask(task, res.task);
					});
				} 
				self.reportarProblema = function( ) {
					$('#reportarFuncionamientoIncorrecto').modal('show');
				} 
				self.guardarEstado = function( ) {
					$('#guardarEstado').modal('show');
				}

				self.restaurarEstado = function( ) {
					alert("Restaurar estado");
				}
				
				self.add = function(task)
				{
					self.ajax(self.tasksURI, 'POST', task).done(function(data) {
						self.tasks.push({
							uri: ko.observable(data.task.uri),
							plazo: ko.observable(data.task.plazo),
							titulo: ko.observable(data.task.titulo),
							descripcion: ko.observable(data.task.descripcion),
							usuario: ko.observable(data.task.usuario),
							password: ko.observable(data.task.password),
							accesoDirecto: ko.observable(data.task.accesoDirecto),
							activo: ko.observable(data.task.activo),
							inactivo: ko.observable(data.task.inactivo),
							pausado: ko.observable(data.task.pausado)
						});
					});
				}

				self.updateTask = function(task, newTask) 
				{
					var i = self.tasks.indexOf(task);
					self.tasks()[i].uri(newTask.uri);
					self.tasks()[i].plazo(newTask.plazo);
					self.tasks()[i].titulo(newTask.titulo);
					self.tasks()[i].descripcion(newTask.descripcion);
					self.tasks()[i].usuario(newTask.usuario);
					self.tasks()[i].password(newTask.password);
					self.tasks()[i].accesoDirecto(newTask.accesoDirecto);
					self.tasks()[i].activo(newTask.activo);
					self.tasks()[i].inactivo(newTask.inactivo);
					self.tasks()[i].pausado(newTask.pausado);
				}

				self.beginLogin = function() 
				{
					$('#login').modal('show');
				}


				self.ajax(self.tasksURI, 'GET').done(function(data) {
					for (var i = 0; i < data.tasks.length; i++) {
						self.tasks.push({
							uri: ko.observable(data.tasks[i].uri),
							plazo: ko.observable(data.tasks[i].plazo),
							titulo: ko.observable(data.tasks[i].titulo),
							descripcion: ko.observable(data.tasks[i].descripcion),
							usuario: ko.observable(data.tasks[i].usuario),
							password: ko.observable(data.tasks[i].password),
							accesoDirecto: ko.observable(data.tasks[i].accesoDirecto),
							activo: ko.observable(data.tasks[i].activo),
							inactivo: ko.observable(data.tasks[i].inactivo),
							pausado: ko.observable(data.tasks[i].pausado)
						});
					}
				}).fail(function(err) {
						if (jqXHR.status == 403)
							setTimeout(self.beginLogin, 500);
				});


/*				self.login = function(username, password)
				{
					self.username = username;
					self.password = password;

					self.ajax(self.tasksURI, 'GET').done(function(data) {
						for (var i = 0; i < data.tasks.length; i++) {
							self.tasks.push({
								uri: ko.observable(data.tasks[i].uri),
								plazo: ko.observable(data.tasks[i].plazo),
								titulo: ko.observable(data.tasks[i].titulo),
								descripcion: ko.observable(data.tasks[i].descripcion),
								usuario: ko.observable(data.tasks[i].usuario),
								password: ko.observable(data.tasks[i].password),
								accesoDirecto: ko.observable(data.tasks[i].accesoDirecto),
								activo: ko.observable(data.tasks[i].activo),
								inactivo: ko.observable(data.tasks[i].inactivo),
								pausado: ko.observable(data.tasks[i].pausado)
							});
						}
					}).fail(function(err) {
						if (jqXHR.status == 403)
							setTimeout(self.beginLogin, 500);
					});
				}

				self.beginLogin();
*/
			}
			
			function AddTaskViewModel() 
			{
				
				var self = this;
				self.plazo = ko.observable();
				self.titulo = ko.observable();
				self.descripcion = ko.observable();
				self.usuario = ko.observable();
				self.password = ko.observable();
				self.accesoDirecto = ko.observable();
				self.addTask = function() {
					$('#add').modal('hide');
					tasksViewModel.add({
						titulo: self.titulo(),
						descripcion: self.descripcion(),
						usuario: self.usuario(),
						password: self.password(),
						accesoDirecto: self.accesoDirecto()
					});

					self.plazo("");
					self.titulo("");
					self.descripcion("");
					self.usuario("");
					self.password("");
					self.accesoDirecto("");
				}
			}

			function LoginViewModel()
			{
				var self = this;
				self.username = ko.observable();
				self.password = ko.observable();

				self.login = function() {
					$('#login').modal('hide');
					tasksViewModel.login(self.username(), self.password());
				}
			}

			function ReportarFuncionamientoIncorrectoViewModel()
			{
				var self = this;
				self.descripcion = ko.observable();

				self.reportarFuncionamientoIncorrecto = function(){
					alert("Reportando");
				}
			}

			function GuardarEstadoViewModel()
			{
				var self = this;
				self.descripcion = ko.observable();

				self.guardarEstado = function(){
					alert("Guardando estado");
				}

			}

		var tasksViewModel = new TasksViewModel();
		var reportarFuncionamientoIncorrectoViewModel = new ReportarFuncionamientoIncorrectoViewModel();
		var guardarEstadoViewModel = new GuardarEstadoViewModel();
		//var loginViewModel = new LoginViewModel();

		ko.applyBindings(tasksViewModel, $('#main')[0]);
		//ko.applyBindings(loginViewModel, $('#login')[0]);
		ko.applyBindings(reportarFuncionamientoIncorrectoViewModel, $('#reportarFuncionamientoIncorrecto')[0]);
		ko.applyBindings(guardarEstadoViewModel, $('#guardarEstado')[0]);

		</script>
	</body>
</html>